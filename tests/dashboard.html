<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sigilo - Dashboard de Privacidade</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .tag-pii { background-color: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 4px; font-weight: bold; border: 1px solid #fcd34d; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800 font-sans">
    <div id="app" class="flex flex-col min-h-screen">

        <!-- Navbar -->
        <nav class="bg-slate-900 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-user-shield text-2xl text-blue-400"></i>
                        <span class="font-bold text-xl tracking-tight">SIGILO <span class="text-blue-400 text-sm font-normal">v1.0</span></span>
                    </div>
                    <div class="flex space-x-4">
                        <button @click="tab = 'demo'" :class="tab === 'demo' ? 'bg-slate-700' : 'hover:bg-slate-800'" class="px-3 py-2 rounded-md text-sm font-medium transition">
                            <i class="fas fa-magic mr-2"></i>Demo
                        </button>
                        <button @click="tab = 'audit'" :class="tab === 'audit' ? 'bg-slate-700' : 'hover:bg-slate-800'" class="px-3 py-2 rounded-md text-sm font-medium transition">
                            <i class="fas fa-list-alt mr-2"></i>Auditoria
                        </button>
                        <button @click="tab = 'status'" :class="tab === 'status' ? 'bg-slate-700' : 'hover:bg-slate-800'" class="px-3 py-2 rounded-md text-sm font-medium transition">
                            <i class="fas fa-server mr-2"></i>Status
                        </button>
                        <!-- Botão para Docs -->
                        <a :href="apiUrl + '/docs'" target="_blank" class="px-3 py-2 rounded-md text-sm font-medium transition hover:bg-slate-800 flex items-center">
                            <i class="fas fa-book-open mr-2"></i>API Docs
                        </a>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-xs text-right hidden sm:block">
                            <p class="text-gray-400">Logado como</p>
                            <p class="font-bold text-blue-300">{{ userRole === 'admin' ? 'Administrador' : 'Usuário' }}</p>
                        </div>
                        <button @click="toggleRole" class="bg-slate-700 p-2 rounded-full hover:bg-slate-600 transition" title="Trocar Perfil (Simulação)">
                            <i class="fas" :class="userRole === 'admin' ? 'fa-user-tie' : 'fa-user'"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Conteúdo Principal -->
        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

            <!-- ABA DEMO -->
            <transition name="fade" mode="out-in">
                <div v-if="tab === 'demo'" key="demo" class="space-y-6">

                    <!-- Área de Input -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-paper-plane text-blue-500"></i> Novo Pedido LAI
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Texto Original (com dados sensíveis)</label>
                                <textarea v-model="texto" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition font-mono text-sm" placeholder="Digite o texto contendo dados sensíveis..."></textarea>
                            </div>
                            <div class="flex justify-between items-center">
                                <button @click="preencherExemplo" class="text-sm text-blue-600 hover:underline">Preencher Exemplo</button>
                                <button @click="enviarPedido" :disabled="loading || !texto" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition shadow-sm flex items-center">
                                    <span v-if="loading"><i class="fas fa-spinner fa-spin mr-2"></i>Processando...</span>
                                    <span v-else>Anonimizar <i class="fas fa-shield-alt ml-2"></i></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Resultado Demo -->
                    <div v-if="resultado" class="animate-fade-in space-y-6">

                        <!-- QUADRO DE DESTAQUE: TEXTO ANONIMIZADO -->
                        <div class="bg-white rounded-xl shadow-lg border-l-8 border-green-500 overflow-hidden">
                            <div class="bg-green-50 px-6 py-4 border-b border-green-100 flex justify-between items-center">
                                <h3 class="font-bold text-green-800 flex items-center gap-2">
                                    <i class="fas fa-check-circle text-xl"></i> Resultado Final (Pronto para Publicação)
                                </h3>
                                <button @click="copiarTexto" class="text-green-700 hover:text-green-900 text-sm font-medium flex items-center gap-1 bg-white px-3 py-1 rounded border border-green-200 shadow-sm hover:shadow transition">
                                    <i class="fas fa-copy"></i> {{ copiado ? 'Copiado!' : 'Copiar Texto' }}
                                </button>
                            </div>
                            <div class="p-6">
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 font-mono text-gray-700 leading-relaxed whitespace-pre-wrap" v-html="textoFormatado"></div>
                            </div>
                        </div>

                        <!-- Detalhes Técnicos (Grid) -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Análise IA -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 border-t-4 border-purple-500">
                                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-brain text-purple-500"></i> Inteligência Artificial
                                </h3>
                                <div v-if="resultado.resumo_inteligente" class="space-y-4 text-sm">
                                    <div class="bg-purple-50 p-3 rounded-lg">
                                        <span class="text-purple-800 font-bold block mb-1">Resumo do Pedido</span>
                                        <p class="text-gray-700 italic">"{{ resultado.resumo_inteligente.assunto_principal }}"</p>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <span class="text-gray-500 text-xs uppercase font-bold">Categoria</span>
                                            <p class="font-medium text-gray-800">{{ resultado.resumo_inteligente.categoria }}</p>
                                        </div>
                                        <div>
                                            <span class="text-gray-500 text-xs uppercase font-bold">Prioridade</span>
                                            <span class="px-2 py-0.5 rounded text-xs font-bold inline-block mt-1" :class="getPrioridadeClass(resultado.resumo_inteligente.prioridade)">
                                                {{ resultado.resumo_inteligente.prioridade }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Estatísticas -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 border-t-4 border-blue-500">
                                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-chart-pie text-blue-500"></i> Estatísticas de Proteção
                                </h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center border-b pb-2">
                                        <span class="text-gray-600">Risco Identificado</span>
                                        <span class="font-bold uppercase" :class="{
                                            'text-green-600': resultado.estatisticas.nivel_risco === 'baixo',
                                            'text-yellow-600': resultado.estatisticas.nivel_risco === 'medio',
                                            'text-red-600': resultado.estatisticas.nivel_risco === 'alto'
                                        }">{{ resultado.estatisticas.nivel_risco }}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600 block mb-2">Entidades Removidas</span>
                                        <div class="flex flex-wrap gap-2">
                                            <span v-for="(qtd, tipo) in resultado.estatisticas.por_tipo" :key="tipo" class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-bold border border-blue-100">
                                                {{ tipo }}: {{ qtd }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ABA AUDITORIA -->
                <div v-else-if="tab === 'audit'" key="audit" class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">Registro de Auditoria</h2>
                        <button @click="carregarAuditoria" class="text-blue-600 hover:text-blue-800"><i class="fas fa-sync-alt"></i> Atualizar</button>
                    </div>

                    <div v-if="userRole !== 'admin'" class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r shadow-sm">
                        <div class="flex items-center">
                            <i class="fas fa-lock text-red-500 mr-3 text-xl"></i>
                            <div>
                                <h3 class="font-bold text-red-800">Acesso Negado</h3>
                                <p class="text-red-700 text-sm">Você precisa ser <b>Administrador</b> para ver os logs de auditoria. Clique no ícone de usuário no topo para trocar.</p>
                            </div>
                        </div>
                    </div>

                    <div v-else class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risco</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entidades</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr v-for="item in auditoriaLista" :key="item.origem_id" class="hover:bg-gray-50 transition">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ new Date(item.created_at).toLocaleString() }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-600">
                                        {{ item.origem_id.substring(0, 8) }}...
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                            :class="{
                                                'bg-green-100 text-green-800': item.nivel_risco === 'baixo',
                                                'bg-yellow-100 text-yellow-800': item.nivel_risco === 'medio',
                                                'bg-red-100 text-red-800': item.nivel_risco === 'alto'
                                            }">
                                            {{ item.nivel_risco }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ item.total_entidades }} detectadas
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button @click="verDetalhes(item.origem_id)" class="text-blue-600 hover:text-blue-900">Detalhes</button>
                                    </td>
                                </tr>
                                <tr v-if="auditoriaLista.length === 0">
                                    <td colspan="5" class="px-6 py-8 text-center text-gray-500 italic">Nenhum registro encontrado.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ABA STATUS -->
                <div v-else-if="tab === 'status'" key="status" class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">Saúde do Sistema</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center gap-4">
                            <div class="p-3 bg-green-100 rounded-full text-green-600"><i class="fas fa-check"></i></div>
                            <div>
                                <p class="text-sm text-gray-500">API Gateway</p>
                                <p class="font-bold text-gray-800">Online</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center gap-4">
                            <div class="p-3 bg-blue-100 rounded-full text-blue-600"><i class="fas fa-database"></i></div>
                            <div>
                                <p class="text-sm text-gray-500">PostgreSQL</p>
                                <p class="font-bold text-gray-800">Conectado</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center gap-4">
                            <div class="p-3 bg-orange-100 rounded-full text-orange-600"><i class="fas fa-envelope"></i></div>
                            <div>
                                <p class="text-sm text-gray-500">RabbitMQ</p>
                                <p class="font-bold text-gray-800">Ativo</p>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>
        </main>

        <!-- Modal Detalhes -->
        <div v-if="modalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Detalhes do Pedido</h3>
                    <button @click="modalOpen = false" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                </div>
                <div v-if="detalhePedido" class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-xs text-gray-500 uppercase font-bold">ID</p>
                        <p class="font-mono text-sm">{{ detalhePedido.origem_id }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1">Texto Processado</p>
                        <p class="text-sm text-gray-700 bg-gray-50 p-3 rounded border">{{ detalhePedido.texto_anonimizado }}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Entidades</p>
                            <ul class="text-sm list-disc list-inside">
                                <li v-for="(qtd, tipo) in detalhePedido.entidades_por_tipo" :key="tipo">{{ tipo }}: {{ qtd }}</li>
                            </ul>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Auditoria</p>
                            <p class="text-sm">Tempo: {{ detalhePedido.auditoria_tecnica.processamento?.tempo_ms }}ms</p>
                            <p class="text-sm text-green-600 font-bold" v-if="detalhePedido.auditoria_tecnica.conformidade?.lgpd">LGPD Compliant</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    apiUrl: 'https://sigilo-api.laredonunes.com',
                    tab: 'demo',
                    userRole: 'user', // user | admin
                    texto: '',
                    loading: false,
                    resultado: null,
                    auditoriaLista: [],
                    modalOpen: false,
                    detalhePedido: null,
                    copiado: false
                }
            },
            computed: {
                authHeader() {
                    const token = this.userRole === 'admin' ? 'mock-admin-token' : 'mock-user-token'
                    return { 'Authorization': `Bearer ${token}` }
                },
                textoFormatado() {
                    if (!this.resultado) return ''
                    // Substitui tags <...> por spans coloridos
                    return this.resultado.texto_anonimizado.replace(/<([A-Z_]+)>/g, '<span class="tag-pii"><$1></span>')
                }
            },
            methods: {
                toggleRole() {
                    this.userRole = this.userRole === 'admin' ? 'user' : 'admin'
                    if (this.tab === 'audit') this.carregarAuditoria()
                },
                preencherExemplo() {
                    this.texto = "Solicito informações sobre o contrato 2024/99. Meu nome é Maria Souza, CPF 123.456.789-00, email maria@teste.com."
                },
                getPrioridadeClass(p) {
                    if (p === 'Alta') return 'bg-red-100 text-red-800'
                    if (p === 'Media') return 'bg-yellow-100 text-yellow-800'
                    return 'bg-green-100 text-green-800'
                },
                async enviarPedido() {
                    this.loading = true
                    this.resultado = null
                    try {
                        const res = await fetch(`${this.apiUrl}/detectar-pii`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...this.authHeader },
                            body: JSON.stringify({ texto: this.texto, protocolo: 'WEB-DEMO' })
                        })
                        if (!res.ok) throw new Error('Erro ao enviar')
                        const data = await res.json()
                        this.monitorar(data.origem_id)
                    } catch (e) {
                        alert(e.message)
                        this.loading = false
                    }
                },
                monitorar(id) {
                    const interval = setInterval(async () => {
                        try {
                            const res = await fetch(`${this.apiUrl}/status/${id}`, { headers: this.authHeader })
                            const data = await res.json()
                            if (data.status === 'completed') {
                                clearInterval(interval)
                                this.resultado = data.result
                                this.loading = false
                            } else if (data.status === 'error') {
                                clearInterval(interval)
                                alert('Erro no processamento')
                                this.loading = false
                            }
                        } catch (e) { clearInterval(interval); this.loading = false; }
                    }, 1000)
                },
                async carregarAuditoria() {
                    if (this.userRole !== 'admin') return
                    try {
                        const res = await fetch(`${this.apiUrl}/auditoria/pedidos`, { headers: this.authHeader })
                        if (res.ok) this.auditoriaLista = await res.json()
                    } catch (e) { console.error(e) }
                },
                async verDetalhes(id) {
                    try {
                        const res = await fetch(`${this.apiUrl}/auditoria/pedidos/${id}`, { headers: this.authHeader })
                        if (res.ok) {
                            this.detalhePedido = await res.json()
                            this.modalOpen = true
                        }
                    } catch (e) { alert('Erro ao carregar detalhes') }
                },
                copiarTexto() {
                    if (!this.resultado) return
                    navigator.clipboard.writeText(this.resultado.texto_anonimizado)
                    this.copiado = true
                    setTimeout(() => this.copiado = false, 2000)
                }
            },
            watch: {
                tab(newVal) {
                    if (newVal === 'audit') this.carregarAuditoria()
                }
            }
        }).mount('#app')
    </script>
</body>
</html>