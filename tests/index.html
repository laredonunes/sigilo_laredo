<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sigilo - Teste de Anonimização</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div id="app" class="max-w-4xl mx-auto">
        <!-- Cabeçalho -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">
                <i class="fas fa-user-secret mr-2 text-blue-600"></i>
                Sigilo - Teste de Anonimização
            </h1>
            <p class="text-gray-600">API: <span class="font-mono bg-gray-100 px-2 py-1 rounded text-sm">{{ apiUrl }}</span></p>
        </div>

        <!-- Formulário -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Texto do Pedido LAI</label>
                <textarea
                    v-model="texto"
                    rows="5"
                    class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Ex: Solicito informações sobre o contrato 123. Meu CPF é 111.222.333-44..."
                ></textarea>
            </div>
            <div class="flex justify-between items-center">
                <button
                    @click="enviarPedido"
                    :disabled="loading || !texto"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition"
                >
                    <span v-if="loading"><i class="fas fa-spinner fa-spin mr-2"></i>Processando...</span>
                    <span v-else><i class="fas fa-shield-alt mr-2"></i>Anonimizar Dados</span>
                </button>
                <button @click="preencherExemplo" class="text-blue-600 hover:underline text-sm">
                    Preencher exemplo
                </button>
            </div>
        </div>

        <!-- Status / Progresso -->
        <div v-if="status" class="bg-white rounded-lg shadow-md p-6 mb-6 animate-fade-in">
            <div class="flex justify-between mb-2">
                <span class="font-bold text-gray-700">Status: {{ status.status }}</span>
                <span class="text-gray-500">{{ status.step }}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div
                    class="bg-blue-600 h-2.5 rounded-full transition-all duration-500"
                    :style="{ width: status.progress + '%' }"
                ></div>
            </div>
        </div>

        <!-- Resultados -->
        <div v-if="resultado" class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">

            <!-- Coluna Esquerda: Texto e Entidades -->
            <div class="space-y-6">
                <!-- Texto Anonimizado -->
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                    <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-file-alt mr-2"></i>Texto Anonimizado</h3>
                    <p class="whitespace-pre-wrap text-gray-700 bg-green-50 p-4 rounded border border-green-100">{{ resultado.texto_anonimizado }}</p>
                </div>

                <!-- Entidades Detectadas -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-search mr-2"></i>Entidades Detectadas</h3>
                    <div class="flex flex-wrap gap-2">
                        <span
                            v-for="(qtd, tipo) in resultado.estatisticas.por_tipo"
                            :key="tipo"
                            class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold"
                        >
                            {{ tipo }}: {{ qtd }}
                        </span>
                        <span v-if="Object.keys(resultado.estatisticas.por_tipo).length === 0" class="text-gray-500 italic">
                            Nenhuma entidade sensível encontrada.
                        </span>
                    </div>
                </div>
            </div>

            <!-- Coluna Direita: Inteligência Artificial -->
            <div class="space-y-6">
                <!-- Resumo Inteligente -->
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                    <h3 class="font-bold text-gray-800 mb-4">
                        <i class="fas fa-brain mr-2 text-purple-600"></i>
                        Análise de IA (Qwen 2.5)
                    </h3>

                    <div v-if="resultado.resumo_inteligente" class="space-y-3">
                        <div>
                            <span class="text-xs font-bold text-gray-500 uppercase">Assunto Principal</span>
                            <p class="text-gray-800 font-medium">{{ resultado.resumo_inteligente.assunto_principal }}</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-xs font-bold text-gray-500 uppercase">Categoria</span>
                                <p class="text-gray-800">{{ resultado.resumo_inteligente.categoria }}</p>
                            </div>
                            <div>
                                <span class="text-xs font-bold text-gray-500 uppercase">Prioridade</span>
                                <span
                                    class="px-2 py-0.5 rounded text-xs font-bold"
                                    :class="{
                                        'bg-red-100 text-red-800': resultado.resumo_inteligente.prioridade === 'Alta',
                                        'bg-yellow-100 text-yellow-800': resultado.resumo_inteligente.prioridade === 'Media',
                                        'bg-green-100 text-green-800': resultado.resumo_inteligente.prioridade === 'Baixa'
                                    }"
                                >
                                    {{ resultado.resumo_inteligente.prioridade }}
                                </span>
                            </div>
                        </div>

                        <div>
                            <span class="text-xs font-bold text-gray-500 uppercase">Palavras-chave</span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                <span
                                    v-for="tag in resultado.resumo_inteligente.palavras_chave"
                                    :key="tag"
                                    class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-xs border border-purple-100"
                                >
                                    #{{ tag }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div v-else class="text-gray-500 italic text-sm">
                        Aguardando análise da IA...
                    </div>
                </div>

                <!-- Auditoria Técnica -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-stopwatch mr-2"></i>Auditoria</h3>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li class="flex justify-between">
                            <span>Tempo Total:</span>
                            <span class="font-mono">{{ resultado.processamento.tempo_ms }}ms</span>
                        </li>
                        <li class="flex justify-between">
                            <span>Risco:</span>
                            <span class="font-bold uppercase" :class="{
                                'text-red-600': resultado.estatisticas.nivel_risco === 'alto',
                                'text-yellow-600': resultado.estatisticas.nivel_risco === 'medio',
                                'text-green-600': resultado.estatisticas.nivel_risco === 'baixo'
                            }">{{ resultado.estatisticas.nivel_risco }}</span>
                        </li>
                        <li class="flex justify-between">
                            <span>ID:</span>
                            <span class="font-mono text-xs truncate w-32" :title="resultado.origem_id">{{ resultado.origem_id }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    apiUrl: 'https://sigilo-api.laredonunes.com',
                    texto: '',
                    loading: false,
                    status: null,
                    resultado: null,
                    pollingInterval: null
                }
            },
            methods: {
                preencherExemplo() {
                    this.texto = "Solicito cópia integral do processo licitatório nº 456/2023 referente à compra de medicamentos. Sou João da Silva, portador do CPF 123.456.789-00 e RG 12.345.678-9. Meu e-mail para contato é joao.silva@email.com.br."
                },
                async enviarPedido() {
                    this.loading = true
                    this.status = { status: 'iniciando', progress: 0, step: 'enviando' }
                    this.resultado = null

                    try {
                        const response = await fetch(`${this.apiUrl}/detectar-pii`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                texto: this.texto,
                                protocolo: `TESTE-${Date.now()}`,
                                usuario_id: 'teste-web'
                            })
                        })

                        if (!response.ok) throw new Error('Erro na API')

                        const data = await response.json()
                        this.monitorarStatus(data.origem_id)

                    } catch (error) {
                        alert('Erro ao enviar pedido: ' + error.message)
                        this.loading = false
                        this.status = null
                    }
                },
                monitorarStatus(id) {
                    this.pollingInterval = setInterval(async () => {
                        try {
                            const response = await fetch(`${this.apiUrl}/status/${id}`)
                            const data = await response.json()

                            this.status = data

                            if (data.status === 'completed') {
                                clearInterval(this.pollingInterval)
                                this.resultado = data.result
                                this.loading = false
                            } else if (data.status === 'error') {
                                clearInterval(this.pollingInterval)
                                alert('Erro no processamento: ' + data.error)
                                this.loading = false
                            }

                        } catch (error) {
                            console.error('Erro no polling:', error)
                        }
                    }, 1000) // Consulta a cada 1 segundo
                }
            }
        }).mount('#app')
    </script>

    <style>
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</body>
</html>